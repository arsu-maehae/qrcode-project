<!DOCTYPE html>
<html lang="th" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QR ‡∏™‡∏∏‡πà‡∏° ‚Ä¢ ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ + ‡∏õ‡∏∏‡πà‡∏°</title>
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0c10" />
  <style>
    :root{ --bg:#0b0c10; --fg:#e5e7eb; --muted:#9ca3af; --card:#111318; --shadow:0 8px 32px rgba(0,0,0,.45); --accent:#2563eb;}
    @media (prefers-color-scheme: light){ :root{ --bg:#ffffff; --fg:#0b0c10; --muted:#6b7280; --card:#f5f6f8; --shadow:0 6px 24px rgba(0,0,0,.08);} }
    html,body{height:100%;}
    body{margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    main.center{min-height:100dvh; padding:calc(env(safe-area-inset-top) + 12px) 16px calc(env(safe-area-inset-bottom) + 96px); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px;}
    .title{font-weight:800; letter-spacing:.2px; text-align:center; margin:0 0 6px;}
    .size{color:var(--muted); font-weight:700; letter-spacing:.2px; text-align:center;}
    .qr-box{display:flex; align-items:center; justify-content:center; background:var(--card); padding:18px; border-radius:22px; box-shadow:var(--shadow); min-height: calc(min(78vw, 360px) + 36px);}
    img.qr{ width:min(78vw, 360px); height:auto; aspect-ratio:1/1; border-radius:16px; background:#fff; display:block; }
    .uuid{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.95rem; color:var(--muted); word-break:break-all; text-align:center;}
    .btns{ display:flex; justify-content:center; align-items:center; gap:10px; width:min(92vw, 440px); flex-wrap:wrap; }
    .btns > center{ display: contents; }
    button{appearance:none; border:none; cursor:pointer; padding:12px 14px; border-radius:14px; font-weight:800; background:var(--accent); color:#fff; box-shadow:var(--shadow); min-height:44px;}
    .btn-dark{background:#111827;}
    .btn-good{background:#16a34a;}
    .btn-float-right{position:fixed; top:calc(10px + env(safe-area-inset-top)); right:12px; z-index:1000; background:#0ea5e9;}
    .btn-play{position:fixed; bottom:calc(16px + env(safe-area-inset-bottom)); left:50%; transform:translateX(-50%); width:min(92vw, 440px); z-index:1000; background:#22c55e; font-size:1.05rem; text-align:center; text-decoration:none; padding:10px 14px; border-radius:14px; color:#fff; font-weight:800;}
    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%); padding:10px 14px; border-radius:12px; background:rgba(0,0,0,.85); color:#fff; z-index:9999;}
    .hidden{display:none !important;}
    .btn-admin-left{ position:fixed; top:calc(10px + env(safe-area-inset-top)); left:12px; z-index:1000; background:#f59e0b; color:#111; font-weight:800; border:none; padding:10px 14px; border-radius:14px; box-shadow:var(--shadow); cursor:pointer;}
  </style>
</head>
<body>
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô -->
  <button id="btnAdmin" class="btn-admin-left" type="button">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ -->
  <a href="Extention.html" class="btn-float-right" style="text-decoration:none;padding:10px 14px;border-radius:14px;background:#0ea5e9;color:#fff;font-weight:800;">
    ‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
  </a>

  <main class="center">
    <h1 class="title">‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</h1>
    <h1 class="title" style="color:#FF0000;">*‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏≤‡∏¢*</h1>
    <div id="sizeLabel" class="size">‡∏Ç‡∏ô‡∏≤‡∏î: ‚Äî</div>
    <div class="qr-box"><img id="qrImg" class="qr" alt="QR"></div>
    <div class="uuid" id="uuidText">‚Äî</div>
    <div class="btns">
      <button id="btnGen">‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</button>
      <button id="btnSave" class="btn-good hidden">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</button>
      <button id="btnCopy" class="btn-dark hidden">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
    </div>
  </main>
  <a id="btnPlay" href="game.html" class="btn-play">‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</a>

  <!-- ‡πÇ‡∏´‡∏•‡∏î Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // üëá ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Supabase
    const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>

  <!-- ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å -->
  <script>
  (function(){
    var img = document.getElementById('qrImg');
    var sizeLabel = document.getElementById('sizeLabel');
    var uuidText = document.getElementById('uuidText');
    var btnGen = document.getElementById('btnGen');
    var btnSave = document.getElementById('btnSave');
    var btnCopy = document.getElementById('btnCopy');
    var btnAdmin = document.getElementById('btnAdmin');

    var QR_PX = 1024;
    var STORAGE_KEY = 'qr_locked_code_v1';
    const ADMIN_PASS = '12345'; // ‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ)

    function toast(msg){
      var el = document.createElement('div');
      el.className = 'toast'; el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 1400);
    }
    function storageGet(){ try{ return localStorage.getItem(STORAGE_KEY) || ''; }catch(e){ return ''; } }
    function storageSet(v){ try{ localStorage.setItem(STORAGE_KEY, v); }catch(e){} }
    function storageDel(){ try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} }

    function shortId(len){
      var alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      var arr = new Uint32Array(len); crypto.getRandomValues(arr);
      return Array.from(arr).map(x => alphabet[x % alphabet.length]).join('');
    }
    function updateSizeLabel(){
      if (img && img.naturalWidth) sizeLabel.textContent = '‡∏Ç‡∏ô‡∏≤‡∏î: ' + img.naturalWidth + '√ó' + img.naturalHeight + ' px';
      else sizeLabel.textContent = '‡∏Ç‡∏ô‡∏≤‡∏î: ' + QR_PX + '√ó' + QR_PX + ' px';
    }
    function drawQR(text){
      var base = 'https://api.qrserver.com/v1/create-qr-code/';
      img.src = base + '?size=' + QR_PX + 'x' + QR_PX + '&format=png&qzone=2&margin=2&data=' + encodeURIComponent(text);
      sizeLabel.textContent = '‡∏Ç‡∏ô‡∏≤‡∏î: ' + QR_PX + '√ó' + QR_PX + ' px';
    }
    function applyLockedUI(code){
      if (!code) return;
      uuidText.textContent = code;
      drawQR(code);
      btnGen.classList.add('hidden');
      btnSave.classList.remove('hidden');
      btnCopy.classList.remove('hidden');
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Supabase
    async function saveToSupabase(code){
      try {
        let { data, error } = await supabase
          .from('qrcodes')
          .insert([{ code: code, user_agent: navigator.userAgent }]);
        if (error) {
          console.error(error); toast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supabase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } else {
          toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supabase ‡πÅ‡∏•‡πâ‡∏ß');
        }
      } catch(e){ console.error(e); toast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
    }

    function handleGenerateOnce(){
      var existed = storageGet();
      if (existed) { applyLockedUI(existed); toast('‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
      var code = shortId(12);
      storageSet(code);
      applyLockedUI(code);
      saveToSupabase(code);   // <<< ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Supabase
      toast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
    }

    async function savePNG(){
      try{
        if(!img || !img.src){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û QR'); return; }
        var res = await fetch(img.src); var blob = await res.blob();
        var url = URL.createObjectURL(blob);
        var name = ('qr-' + (uuidText.textContent || Date.now()) + '.png').replace(/[^a-zA-Z0-9._-]/g,'_');
        var a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      }catch(e){ window.open(img.src, '_blank'); }
    }
    function copyCode(){
      var txt = uuidText.textContent || '';
      if(!txt){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'); return; }
      navigator.clipboard?.writeText(txt);
      toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    }
    function adminResetUI(){
      storageDel();
      uuidText.textContent = '‚Äî';
      if (img) img.removeAttribute('src');
      updateSizeLabel();
      btnGen.classList.remove('hidden');
      btnSave.classList.add('hidden');
      btnCopy.classList.add('hidden');
      toast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
    }

    btnAdmin.addEventListener('click', ()=>{
      var input = prompt('‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
      if (input === null) return;
      if ((input||'').trim() === ADMIN_PASS){
        if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) adminResetUI();
      } else toast('‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    });

    img.addEventListener('load', updateSizeLabel);
    btnGen.addEventListener('click', handleGenerateOnce);
    btnSave.addEventListener('click', savePNG);
    btnCopy.addEventListener('click', copyCode);

    var locked = storageGet();
    if (locked){ applyLockedUI(locked); } else { uuidText.textContent = '‚Äî'; img.removeAttribute('src'); updateSizeLabel(); }
  })();
  </script>
</body>
</html>
